<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Pro</title>

<style>
body{
  margin:0;
  background:#070b14;
  color:#fff;
  font-family:sans-serif;
  padding:20px;
}

.card{
  background:#121826;
  border-radius:20px;
  padding:20px;
  margin:15px 0;
}

.scroll{
  overflow-x:auto;
}

canvas{
  width:100%!important;
  height:260px!important;
}

button{
  margin-right:10px;
  padding:8px 12px;
}
  .bill-card{
background:#121826;
border-radius:20px;
padding:15px;
margin:12px 0;
border:1px solid rgba(255,255,255,.05)
}

.bill-row{
display:flex;
justify-content:space-between;
font-size:13px;
margin-top:5px
}

.badge{
padding:3px 8px;
border-radius:10px;
font-size:11px
}

.badge-paid{background:#10b981}
.badge-unpaid{background:#ef4444}
.badge-overdue{background:#f59e0b}

.pay-btn{
margin-top:10px;
padding:6px 10px;
border:none;
border-radius:10px;
background:#38bdf8;
color:#000;
font-weight:600
}
</style>
</head>

<body>

<h2>Dashboard Pro</h2>

<div id="netWorthCards"></div>
<div id="billSection"></div>
<div id="creditSummary"></div>

<div class="scroll">
  <canvas id="creditChart"></canvas>
</div>
<div class="scroll">
  <button onclick="setChart('line')">Graph</button>
  <button onclick="setChart('bar')">Bar</button>
  <canvas id="nwChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

/* ⭐ API URL डालो */
const API_URL="https://script.google.com/macros/s/AKfycbwxGSfdB6Ng1Ya-2fxTFKwBYiWWbM5usDVkWr1MCP7dJX7JRSJfGaBu-vfTFmT5-XUe/exec";

/* ⭐ formatter */
const fmt=n=>new Intl.NumberFormat('en-IN',{
  style:'currency',
  currency:'INR'
}).format(Number(n)||0);

/* ⭐ chart engine */
let chartType='line';
let chartInstance=null;

function setChart(type){
  chartType=type;
  loadChart();
}

/* ⭐ dashboard cards */
async function loadNetWorth(){
  try{
    const res=await fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({action:"getDashboardPlus"})
    }).then(r=>r.json());

    document.getElementById("netWorthCards").innerHTML=`
      <div class="card">
        <h3>NET WORTH</h3>
        <h2>${fmt(res.currentNetWorth)}</h2>
        Assets: ${fmt(res.assets)}<br>
        Liabilities: ${fmt(res.liabilities)}<br>
        ${fmt(res.profitLoss)}
      </div>`;
  }catch(e){
    console.log(e);
  }
}

/* ⭐ chart loader */
async function loadChart(){
  if(typeof Chart==="undefined") return;

  try{
    const snap=await fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({action:"getSnapshots"})
    }).then(r=>r.json());

    if(chartInstance) chartInstance.destroy();

    chartInstance=new Chart(document.getElementById('nwChart'),{
      type:chartType,
      data:{
        labels:snap.months,
        datasets:[{
          label:'Net Worth',
          data:snap.netWorth,
          borderColor:'#38bdf8',
          backgroundColor:'#38bdf8',
          tension:0.3
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false
      }
    });
  }catch(e){
    console.log(e);
  }
}
async function loadCredit(){
  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"getDashboard"})
  }).then(r=>r.json());

  const used = res.cardLiab || 0;
  const limit = res.cardLimit || 0;
  const avail = limit-used;
  const util = res.utilization || 0;

  document.getElementById("creditSummary").innerHTML=`
  <div class="net-card">
    <div class="net-title">CREDIT DASHBOARD</div>
    <div class="net-row">
      <span>Limit: ${fmt(limit)}</span>
      <span>Used: ${fmt(used)}</span>
    </div>
    <div class="net-row">
      <span>Available: ${fmt(avail)}</span>
      <span>${util.toFixed(1)}%</span>
    </div>
  </div>`;
}

  },300);
});
async function loadBills(){

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"generateBills"})
  });

  const res = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"getBills"})
  }).then(r=>r.json());

  let html="";

  res.bills.forEach(b=>{

    const due = new Date(b.dueDate);
    const today = new Date();
    const diff = Math.ceil((due-today)/(1000*60*60*24));

    let badge="badge-unpaid";
    if(b.status==="paid") badge="badge-paid";
    if(b.overdue) badge="badge-overdue";

    html+=`
    <div class="bill-card">
      <b>${b.card}</b>

      <div class="bill-row">
        <span>Bill</span>
        <span>${fmt(b.amount)}</span>
      </div>

      <div class="bill-row">
        <span>Min due</span>
        <span>${fmt(b.minDue)}</span>
      </div>

      <div class="bill-row">
        <span>Due</span>
        <span>${diff>0?diff+" days": "Overdue"}</span>
      </div>

      <div class="bill-row">
        <span>Status</span>
        <span class="badge ${badge}">${b.status}</span>
      </div>

      ${b.status!=="paid"?
        `<button class="pay-btn" onclick="payBill('${b.id}',${b.amount})">Pay</button>`:""}
    </div>`;
  });

  document.getElementById("billSection").innerHTML=html;
}

async function payBill(id,amt){

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"payBill",billId:id,amount:amt})
  });

  loadBills();
}
  /* ⭐ safe loader */
window.addEventListener("DOMContentLoaded",()=>{
  setTimeout(()=>{
    loadNetWorth();
    loadChart();
    loadCredit();
    loadBills();
    
</script>

</body>
</html>
